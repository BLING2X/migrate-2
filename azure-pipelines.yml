trigger:
- "*"

variables:
  rp: go/src/github.com/actions/migrate
  wd: $(Pipeline.Workspace)/$(rp)
  GOPATH: $(Pipeline.Workspace)/go

strategy:
  matrix:
    windows:
      os: vs2017-win2016
      isWin: true
    linux:
      os: 'ubuntu-16.04'
      isWin: false
    osx:
      os: macOS-10.13
      isWin: false

pool:
  vmImage: $(os)

steps:
- checkout: self
  path: $(rp)
- task: GoTool@0
  inputs:
    version: '1.12'
    workingDirectory: $(wd)
- bash: ./script/build
  displayName: Check format
  continueOnError: true
  workingDirectory: $(wd)
- bash: ./script/build
  displayName: Build
  workingDirectory: $(wd)
- bash: ls -l "$(wd)"
  displayName: See what is built
- bash: ./script/test
  displayName: Test
  workingDirectory: $(wd)
- task: UseRubyVersion@0
  inputs:
    versionSpec: '>= 2.4'
    addToPath: true
- bash: ruby ./script/functional-test.rb
  workingDirectory: $(wd)
  displayName: "Functional test of binary"
